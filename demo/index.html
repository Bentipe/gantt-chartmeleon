<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt Chart Library Demo</title>
    <!-- Load CSS from npm CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@bentipe/gantt-chartmeleon@1.1.1/dist/gantt-chartmeleon.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* Demo of per-segment custom CSS via className */
        .gantt-task-segment.highlighted-seg .gantt-task-bar {
            stroke: #FF5722;
            stroke-width: 3px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        h1 {
            margin-bottom: 20px;
            color: #333;
        }

        .controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .controls button {
            margin-right: 10px;
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .controls button:hover {
            background: #f0f0f0;
        }

        .controls button.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        #gantt-container {
            height: 600px;
        }

        .info {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .info h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .info pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
<h1>ðŸ“Š Gantt Chart Library Demo</h1>

<div class="controls">
    <button class="view-btn" data-view="hour">Hours</button>
    <button class="view-btn active" data-view="day">Days</button>
    <button class="view-btn" data-view="week">Weeks</button>
    <button class="view-btn" data-view="month">Months</button>
    <button id="add-task">Add Task</button>
    <button id="add-group">Add Group</button>
    <button id="add-subgroup">Add Subgroup</button>
    <button id="toggle-theme">Toggle Theme</button>
    <button id="expand-all">Expand All</button>
    <button id="collapse-all">Collapse All</button>
    <button id="zoom-in">Zoom In</button>
    <button id="zoom-out">Zoom Out</button>
    <button id="today">Today</button>
    <button id="stress-test">Stress Test (2000 tasks)</button>
</div>

<div id="gantt-container"></div>

<div class="info">
    <h3>Counters:</h3>
    <div id="counters">Tasks: 0 | Segments: 0</div>
</div>

<div class="info">
    <h3>Last Event:</h3>
    <pre id="event-log">Waiting for events...</pre>
</div>

<script type="module">
    //import { GanttChart } from 'https://cdn.jsdelivr.net/npm/@bentipe/gantt-chartmeleon@1.1.1/dist/gantt-chartmeleon.es.js';
    import { GanttChart } from '../src/gantt-chartmeleon.js';

    // Initialize Gantt Chart
    const gantt = new GanttChart('#gantt-container', {
        viewMode: 'day',
        enableDragDrop: true,
        showSidebar: true
    });

    // Sample data
    const today = new Date();

    const groups = [
        {
            id: 'planning',
            name: 'Planning Phase',
            workOrder: 'WO-2024-PLAN'
        },
        {
            id: 'development',
            name: 'Development Phase',
            workOrder: 'WO-2024-DEV'
        },
        // Nested groups under Development
        {
            id: 'dev-backend',
            name: 'Backend Team',
            workOrder: 'WO-2024-DEV-BE',
            parent: 'development'
        },
        {
            id: 'dev-frontend',
            name: 'Frontend Team',
            workOrder: 'WO-2024-DEV-FE',
            parent: 'development'
        },
        {
            id: 'testing',
            name: 'Testing Phase',
            workOrder: 'WO-2024-TEST'
        }
    ];

    const tasks = [
        // Planning tasks
        {
            id: 'task-1',
            name: 'Project Kickoff',
            segments: [
                {
                    name: 'Project Kickoff',
                    start: new Date(today.getTime() - 10 * 24 * 60 * 60 * 1000),
                    end: new Date(today.getTime() - 9 * 24 * 60 * 60 * 1000),
                    color: '#4CAF50'
                }
            ],
            progress: 100,
            color: '#4CAF50',
            group: 'planning',
            workOrder: 'WO-001',
            assignee: 'John Doe',
            type: 'milestone'
        },
        {
            id: 'task-2',
            name: 'Requirements Gathering',
            segments: [
                { name: 'Requirements Gathering', start: new Date(today.getTime() - 9 * 24 * 60 * 60 * 1000), end: new Date(today.getTime() - 5 * 24 * 60 * 60 * 1000), color: '#4CAF50' }
            ],
            progress: 100,
            color: '#4CAF50',
            group: 'planning',
            workOrder: 'WO-002',
            assignee: 'Jane Smith'
        },
        {
            id: 'task-3',
            name: 'Technical Design',
            segments: [
                { name: 'Technical Design', start: new Date(today.getTime() - 5 * 24 * 60 * 60 * 1000), end: new Date(today.getTime() - 2 * 24 * 60 * 60 * 1000), color: '#4CAF50' }
            ],
            progress: 100,
            color: '#4CAF50',
            group: 'planning',
            workOrder: 'WO-003',
            assignee: 'Bob Johnson',
            dependencies: ['task-2']
        },

        // Development tasks
        {
            id: 'task-4',
            name: 'Backend Development',
            segments: [
                { name: 'Backend Development', start: new Date(today.getTime() - 2 * 24 * 60 * 60 * 1000), end: new Date(today.getTime() + 5 * 24 * 60 * 60 * 1000), color: '#2196F3' }
            ],
            progress: 60,
            color: '#2196F3',
            group: 'dev-backend',
            workOrder: 'WO-004',
            assignee: 'Dev Team A',
            dependencies: ['task-3']
        },
        {
            id: 'task-5',
            name: 'Frontend Development',
            // Demonstrate segmented task: multiple movable segments with names
            segments: [
                {
                    name: 'FE Sprint 1',
                    start: new Date(today.getTime()),
                    end: new Date(today.getTime() + 2 * 24 * 60 * 60 * 1000),
                    color: '#1E88E5'
                },
                {
                    name: 'FE Sprint 2',
                    start: new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000),
                    end: new Date(today.getTime() + 5 * 24 * 60 * 60 * 1000),
                    color: '#1976D2',
                    className: 'highlighted-seg',
                    // Inline style can also be provided (string or object)
                    style: { filter: 'drop-shadow(0 0 4px rgba(0,0,0,0.3))' }
                },
                {
                    name: 'FE Sprint 3',
                    start: new Date(today.getTime() + 6 * 24 * 60 * 60 * 1000),
                    end: new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000),
                    color: '#1565C0'
                }
            ],
            progress: 40,
            color: '#2196F3',
            group: 'dev-frontend',
            workOrder: 'WO-005',
            assignee: 'Dev Team B',
            dependencies: ['task-3']
        },
        {
            id: 'task-6',
            name: 'API Integration',
            segments: [
                { name: 'API Integration', start: new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000), end: new Date(today.getTime() + 8 * 24 * 60 * 60 * 1000), color: '#FF9800' }
            ],
            progress: 0,
            color: '#FF9800',
            group: 'development',
            workOrder: 'WO-006',
            assignee: 'Integration Team',
            dependencies: ['task-4', 'task-5']
        },

        // Testing tasks
        {
            id: 'task-7',
            name: 'Unit Testing',
            segments: [
                { name: 'Unit Testing', start: new Date(today.getTime() + 5 * 24 * 60 * 60 * 1000), end: new Date(today.getTime() + 9 * 24 * 60 * 60 * 1000), color: '#9C27B0' }
            ],
            progress: 0,
            color: '#9C27B0',
            group: 'testing',
            workOrder: 'WO-007',
            assignee: 'QA Team',
            dependencies: ['task-4', 'task-5']
        },
        {
            id: 'task-8',
            name: 'Integration Testing',
            segments: [
                { name: 'Integration Testing', start: new Date(today.getTime() + 8 * 24 * 60 * 60 * 1000), end: new Date(today.getTime() + 11 * 24 * 60 * 60 * 1000), color: '#9C27B0' }
            ],
            progress: 0,
            color: '#9C27B0',
            group: 'testing',
            workOrder: 'WO-008',
            assignee: 'QA Team',
            dependencies: ['task-6', 'task-7']
        },
        {
            id: 'task-9',
            name: 'UAT',
            segments: [
                { name: 'UAT', start: new Date(today.getTime() + 11 * 24 * 60 * 60 * 1000), end: new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000), color: '#E91E63' }
            ],
            progress: 0,
            color: '#E91E63',
            group: 'testing',
            workOrder: 'WO-009',
            assignee: 'Client Team',
            dependencies: ['task-8']
        },
        {
            id: 'task-10',
            name: 'Go Live',
            segments: [
                { name: 'Go Live', start: new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000), end: new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000), color: '#F44336' }
            ],
            progress: 0,
            color: '#F44336',
            type: 'milestone',
            workOrder: 'WO-010',
            dependencies: ['task-9']
        }
    ];

    // Set tasks and groups
    gantt.setTasks(tasks, groups);

    // Mark today
    gantt.markDay(today, 'today', '#FFD700');

    // Mark weekend
    const weekend = new Date(today);
    weekend.setDate(weekend.getDate() + ((6 - weekend.getDay()) || 7));
    gantt.markDay(weekend, 'weekend');

    // Event logging
    const logEvent = (message) => {
        document.getElementById('event-log').textContent =
            `[${new Date().toLocaleTimeString()}] ${message}`;
    };

    // Helper: counters
    const updateCounters = () => {
        const all = gantt.getTasks();
        const totalTasks = all.length;
        const totalSegments = all.reduce((sum, t) => sum + (Array.isArray(t.segments) ? t.segments.length : 0), 0);
        const el = document.getElementById('counters');
        if (el) el.textContent = `Tasks: ${totalTasks} | Segments: ${totalSegments}`;
    };

    // Update counters after initial load
    updateCounters();

    // Register event listeners
    gantt.on('taskClick', (payload) => {
        if (payload && payload.task) {
            const segInfo = payload.segmentIndex !== null && payload.segmentIndex !== undefined ? ` [segment ${payload.segmentIndex + 1}]` : '';
            logEvent(`Task clicked: ${payload.task.name}${segInfo}`);
        } else if (payload) {
            logEvent(`Task clicked: ${payload.name}`);
        }
    });

    gantt.on('taskDrop', (data) => {
        const segInfo = data.segmentIndex !== null && data.segmentIndex !== undefined ? ` [segment ${data.segmentIndex + 1}]` : '';
        logEvent(`Task moved${segInfo}: ${data.task.name} to ${data.start.toLocaleDateString()}`);
    });

    // Keep counters in sync with task changes
    gantt.on('tasksSet', () => updateCounters());
    gantt.on('taskAdd', () => updateCounters());
    gantt.on('taskRemove', () => updateCounters());
    gantt.on('taskUpdate', () => updateCounters());

    gantt.on('groupClick', (group) => {
        logEvent(`Group clicked: ${group.name}`);
    });

    gantt.on('groupCollapse', (groupId) => {
        logEvent(`Group collapsed: ${groupId}`);
    });

    gantt.on('groupExpand', (groupId) => {
        logEvent(`Group expanded: ${groupId}`);
    });

    // Control buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            gantt.setViewMode(e.target.dataset.view);
            logEvent(`View mode changed to: ${e.target.dataset.view}`);
        });
    });

    document.getElementById('add-task').addEventListener('click', () => {
        const colors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0'];
        const names = ['New Feature', 'Bug Fix', 'Documentation', 'Review'];
        const allGroups = gantt.getGroups();
        const randomGroup = allGroups[Math.floor(Math.random() * allGroups.length)];

        const baseColor = colors[Math.floor(Math.random() * colors.length)];
        const baseName = names[Math.floor(Math.random() * names.length)];

        // Always create segmented tasks (1..8 segments)
        const segmentCount = Math.floor(Math.random() * 8) + 1; // 1..8
        const startOffsetDays = Math.floor(Math.random() * 10); // 0..9 days from today
        let cursor = new Date(today.getTime() + startOffsetDays * 24 * 60 * 60 * 1000);
        const segments = [];
        for (let i = 0; i < segmentCount; i++) {
            const durDays = Math.floor(Math.random() * 4) + 1; // 1..4
            const segStart = new Date(cursor);
            const segEnd = new Date(segStart.getTime() + durDays * 24 * 60 * 60 * 1000);
            segments.push({
                name: `${baseName} â€¢ Segment ${i + 1}`,
                start: segStart,
                end: segEnd,
                color: baseColor
            });
            const gapDays = Math.floor(Math.random() * 3); // 0..2 gap
            cursor = new Date(segEnd.getTime() + gapDays * 24 * 60 * 60 * 1000);
        }
        const payload = {
            name: baseName,
            segments,
            progress: Math.floor(Math.random() * 100),
            color: baseColor,
            group: randomGroup ? randomGroup.id : null,
            workOrder: `WO-${Date.now()}`,
            assignee: 'New User'
        };

        const newTask = gantt.addTask(payload);
        const segNote = Array.isArray(newTask.segments) ? ` with ${newTask.segments.length} segment(s)` : '';
        logEvent(`Added task: ${newTask.name}${segNote}`);
        updateCounters();
    });

    document.getElementById('add-group').addEventListener('click', () => {
        const group = gantt.addGroup({
            name: `New Phase ${Date.now().toString().slice(-4)}`,
            workOrder: `WO-GRP-${Date.now()}`
        });

        logEvent(`Added group: ${group.name}`);
    });

    document.getElementById('add-subgroup').addEventListener('click', () => {
        const parents = gantt.getGroups();
        if (!parents || parents.length === 0) {
            logEvent('No groups available to add a subgroup.');
            return;
        }
        const parent = parents[Math.floor(Math.random() * parents.length)];
        const subgroup = gantt.addGroup({
            name: `Child of ${parent.name}`,
            workOrder: `WO-SUBGRP-${Date.now()}`,
            parent: parent.id
        });
        logEvent(`Added subgroup: ${subgroup.name} (parent: ${parent.name})`);
    });

    let isDark = false;
    document.getElementById('toggle-theme').addEventListener('click', () => {
        isDark = !isDark;
        document.getElementById('gantt-container').classList.toggle('gantt-theme-dark', isDark);
        logEvent(`Theme changed to: ${isDark ? 'dark' : 'light'}`);
    });

    document.getElementById('expand-all').addEventListener('click', () => {
        gantt.expandAll();
        logEvent('All groups expanded');
    });

    document.getElementById('collapse-all').addEventListener('click', () => {
        gantt.collapseAll();
        logEvent('All groups collapsed');
    });

    // Zoom controls
    document.getElementById('zoom-in').addEventListener('click', () => {
        gantt.zoomIn();
        logEvent(`Zoomed in (column width: ${gantt.getZoom()}px)`);
    });
    document.getElementById('zoom-out').addEventListener('click', () => {
        gantt.zoomOut();
        logEvent(`Zoomed out (column width: ${gantt.getZoom()}px)`);
    });

    // Today control
    document.getElementById('today').addEventListener('click', () => {
        gantt.scrollToToday({ align: 'center', behavior: 'smooth' });
        logEvent('Scrolled to today');
    });

    // Stress test: generate a lot of tasks with segments and load them
    const generateStressData = (count = 2000, minSeg = 2, maxSeg = 8) => {
        const colors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#E91E63', '#00BCD4'];
        const names = ['Feature', 'Fix', 'Refactor', 'Docs', 'Review', 'Spike'];
        const result = [];
        const groupIds = (groups || []).map(g => g.id);
        for (let i = 0; i < count; i++) {
            const baseColor = colors[i % colors.length];
            const baseName = `${names[i % names.length]} ${i + 1}`;
            const segCount = Math.floor(Math.random() * (maxSeg - minSeg + 1)) + minSeg;
            // Spread tasks across ~90 days around today
            const startOffset = (Math.random() * 60) - 30; // -30..+30 days
            let cursor = new Date(today.getTime() + Math.floor(startOffset) * 24 * 60 * 60 * 1000);
            const segments = [];
            for (let s = 0; s < segCount; s++) {
                const durDays = Math.floor(Math.random() * 5) + 1; // 1..5 days
                const segStart = new Date(cursor);
                const segEnd = new Date(segStart.getTime() + durDays * 24 * 60 * 60 * 1000);
                segments.push({
                    name: `${baseName} â€¢ S${s + 1}`,
                    start: segStart,
                    end: segEnd,
                    color: baseColor
                });
                const gapDays = Math.floor(Math.random() * 3); // 0..2 gap
                cursor = new Date(segEnd.getTime() + gapDays * 24 * 60 * 60 * 1000);
            }
            result.push({
                name: baseName,
                segments,
                progress: Math.floor(Math.random() * 100),
                color: baseColor,
                group: groupIds.length ? groupIds[i % groupIds.length] : null,
                workOrder: `WO-STRESS-${i.toString().padStart(4, '0')}`,
                assignee: `User ${i % 50}`
            });
        }
        return result;
    };

    document.getElementById('stress-test').addEventListener('click', () => {
        const stressTasks = generateStressData(2000, 2, 8);
        // Keep existing groups; replace current tasks with stress dataset
        gantt.setTasks(stressTasks, groups);
        logEvent(`Loaded stress dataset: ${stressTasks.length} tasks with segments`);
        updateCounters();
    });

    // Log initial load
    logEvent('Gantt chart loaded successfully');
</script>
</body>
</html>
